<?php 
	session_start();
	if(!$_SESSION['iduser']){
		header('Location:../index.php');
	}
	
require('../connection.php');

require('../declarationVariables.php');

$reponse="produit non enregistrer";

$operation=@htmlspecialchars($_POST["operation"]);

if($operation == 1){
    $source = [];
    $query=htmlspecialchars(trim($_POST['query']));
    $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ORDER BY idDesignation ASC";
    $resS=mysql_query($reqS) or die ("insertion impossible");

    if($resS){
          while ($data=mysql_fetch_array($resS)) {

          if($data['uniteStock']!='Transaction'){
              if($data['classe']==0){ 
                if ($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                  $sql_t="SELECT * FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."'  ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  if(mysql_num_rows($res_t)){
                    $sql_E="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."' ";
                    $res_E=mysql_query($sql_E) or die ("select stock impossible =>".mysql_error());
                    $t_stock = mysql_fetch_array($res_E) ;
                         $source[] = $data['designation'].' => '.$t_stock[0];
                  }  
                }
                else{
                  $sql_t="SELECT * FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."'  ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  if(mysql_num_rows($res_t)){
                        $source[] = $data['designation'];
                  }
                }      
              }
              if($data['classe']==1){
                $source[] = $data['designation'];
              }
              if($data['classe']==2){
                    $source[] = $data['designation'];
              }
              if($data['classe']==3){
                if($data['seuil']==1){
                    $source[] = $data['designation'];
                }
              }
              if($data['classe']==5){
                 $source[] = $data['designation'];
              }
              if($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                if($data['classe']==6){
                    $source[] = $data['designation'];
                }
              }
              if($data['classe']==7){
                 $source[] = $data['designation'];
              }
              if ($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                if($data['classe']==8){
                    $source[] = $data['designation'];
                }
              }
              if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                if($data['classe']==9){
                    $source[] = $data['designation'];
                }
              }
              if ($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                if($data['classe']==10){
                   $source[] = $data['designation'];
                }
              }
              if ($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                if($data['classe']==20){
                    $source[] = $data['designation'];
                }
              }
            }
        }
  }

    echo json_encode($source);
}
if($operation == 2){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

  if($resS){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resS)) {
            if($data['uniteStock']!='Transaction' && $data['uniteStock']!='Facture' && $data['uniteStock']!='Credit'){
                if($data['classe']==0){
                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."' ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  $t_stock = mysql_fetch_array($res_t) ;
                  if($t_stock[0]>0){
                    $reponse.="     <li class='lic' style='background-color: #abdbb7; '>".$data['designation']." <span style='display:none'>=></span>&nbsp;&nbsp;<span disabled='true' class='badge bg-warning'>".$t_stock[0]."</span></li>";
                  }        
                }
                if($data['classe']==1){
                  $reponse.="<li class='lic'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
                }
                if($data['classe']==6){
                  $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                }
                if ($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                  if($data['classe']==8){
                    $reponse.="<li class='lic'  style='background-color: #f0a7a1ed; '>".$data['designation']." </li>";
                  }
                }
                if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                  if($data['classe']==9){
                    $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                  }
                }
              }
          }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 3){
  $source = [];
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");
  //  
  if($resS){
        while ($data=mysql_fetch_array($resS)) {
              if($data['forme']!='Transaction' && $data['forme']!='Facture' && $data['forme']!='Credit'){
                  if($data['classe']==0){
                    $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."' ";
                    $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                    $t_stock = mysql_fetch_array($res_t) ;
                    if($t_stock[0]>0){
                      $source[] = $data['designation'].' => '.$t_stock[0];
                    }        
                  }
                  if($data['classe']==1){
                    $source[] = $data['designation'];
                      }
                  if($data['classe']==2){
                    $source[] = $data['designation'];
                  }
                  if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                    if($data['classe']==9){
                      $source[] = $data['designation'];
                    }
                  }
                }
            }
    }
  echo json_encode($source);

}
if($operation == 4){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

  if($resS){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resS)) {
            // $reponse.="<li class='lic'>".$data['designation']."-".$data['idDesignation']."</li>";
            /*if($data['uniteStock']=='Transaction' && $data['seuil']==1){
              $reponse.="<li class='lic' style='background-color: #e0dd21ed; '>".$data['designation']." </li>";
            }*/
            if($data['forme']!='Transaction' && $data['forme']!='Facture' && $data['forme']!='Credit'){
                if($data['classe']==0){
                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."' ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  $t_stock = mysql_fetch_array($res_t) ;
                  if($t_stock[0]>0){
                    $reponse.="     <li class='lic' style='background-color: #abdbb7; '>".$data['designation']." <span style='display:none'>=></span>&nbsp;&nbsp;<span disabled='true' class='badge bg-warning'>".$t_stock[0]."</span></li>";
                  }        
                }
                if($data['classe']==1){
                  $reponse.="<li class='lic'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
                }
                if($data['classe']==6){
                  $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                }
                if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                  if($data['classe']==9){
                    $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                  }
                }
              }
          }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 5){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

  if($resS){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resS)) {
            // $reponse.="<li class='lic'>".$data['designation']."-".$data['idDesignation']."</li>";
            if(($data['uniteStock']=='Transaction' || $data['uniteStock']=='Credit')  && $data['seuil']==1){
              $reponse.="<li class='lic' style='background-color: #e0dd21ed; '>".$data['designation']." </li>";
            }
            if($data['uniteStock']!='Transaction' && $data['uniteStock']!='Facture' && $data['uniteStock']!='Credit'){
                if($data['classe']==0){
                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."' ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  $t_stock = mysql_fetch_array($res_t) ;
                  if($t_stock[0]>0){
                    $reponse.="     <li class='lic' style='background-color: #abdbb7; '>".$data['designation']." <span style='display:none'>=></span>&nbsp;&nbsp;<span disabled='true' class='badge bg-warning'>".$t_stock[0]."</span></li>";
                  }        
                }
                if($data['classe']==1){
                  $reponse.="<li class='lic'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
                }
                if($data['classe']==2){
                  $reponse.="<li class='lic'  style='background-color: #f0a7a1ed; '>".$data['designation']." </li>";
                }
                if($data['classe']==5){
                  $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                }
                if($data['classe']==7){
                  $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                }
                if($data['classe']==8){
                  $reponse.="<li class='lic'  style='background-color: #f0a7a1ed; '>".$data['designation']." </li>";
                }
                if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                  if($data['classe']==9){
                    $reponse.="<li class='lic'  style='background-color: #aceef3; '>".$data['designation']." </li>";
                  }
                }
              }
          }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 6){
  //$reponse+=sizeof($codeBrute);
  $designation=@htmlspecialchars($_POST["designation"]);
  $idPagnet=@htmlspecialchars($_POST["idPagnet"]);
  $result="0";

  $sql="SELECT * FROM `".$nomtableDesignation."` where (codeBarreDesignation='".$designation."' or codeBarreuniteStock='".$designation."' or designation='".$designation."') ";
  $res=mysql_query($sql) or die ("select stock impossible =>".mysql_error());
  if(mysql_num_rows($res)){
    $design = mysql_fetch_assoc($res);
    if($design['classe']==0){
      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$design['idDesignation']."' ";
      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
      $t_stock = mysql_fetch_array($res_t) ;
      $restant = $t_stock[0];
      if($restant>0){
          /***Debut verifier si la ligne du produit existe deja ***/
          $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and classe=0 ";
          $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
          $ligne = mysql_fetch_assoc($res);
          /***Debut verifier si la ligne du produit existe deja ***/
          if($ligne != null){
              $quantite = $ligne['quantite'] + 1;
              $reste = $t_stock[0] - $quantite;
              if ($reste>=0){
                  $prixTotal=$quantite*$ligne['prixPublic'];
                  $sql7="UPDATE `".$nomtableLigne."` set quantite=".$quantite.",prixtotal=".$prixTotal." where idPagnet=".$idPagnet." and idDesignation=".$design['idDesignation'];
                  $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());

                  $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                  $res2=mysql_query($sql2);
                  if(mysql_num_rows($res2)){
                    $ligne=mysql_fetch_assoc($res2);
                    $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                    $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                    $TotalT = mysql_fetch_array($resT) ;
                    $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$quantite;
                  }
              }
              else{
                  $result='3<>'.$t_stock[0];
              }                     
          }
          else {
              $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
              $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
              $ligne = mysql_fetch_assoc($res) ;
              if(mysql_num_rows($res)){
                  if($ligne['classe']==0 || $ligne['classe']==1){
                      $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",0)";
                      $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                      $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                      $res2=mysql_query($sql2);
                      if(mysql_num_rows($res2)){
                        $ligne=mysql_fetch_assoc($res2);
                        $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                        $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                        $TotalT = mysql_fetch_array($resT) ;
                        $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
                      }
                  }
              }
              else{
                  $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",0)";
                  $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                  $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                  $res2=mysql_query($sql2);
                  if(mysql_num_rows($res2)){
                    $ligne=mysql_fetch_assoc($res2);
                    $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                    $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                    $TotalT = mysql_fetch_array($resT) ;
                    $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
                  }
              }
          
          }
      }
      else{
        $result='3<>0';
      }
    }
    if($design['classe']==1){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and classe=1 ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixPublic'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite=".$quantite.",prixtotal=".$prixTotal." where idPagnet=".$idPagnet." and idDesignation=".$design['idDesignation'];
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());

                $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                $res2=mysql_query($sql2);
                if(mysql_num_rows($res2)){
                  $ligne=mysql_fetch_assoc($res2);
                  $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                  $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                  $TotalT = mysql_fetch_array($resT) ;
                  $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$quantite;
                }
            }
            else {
                if($ligne['classe']==1){
                    if($design['forme']!='Transaction'){
                      $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",1)";
                      $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                      $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                      $res2=mysql_query($sql2);
                      if(mysql_num_rows($res2)){
                        $ligne=mysql_fetch_assoc($res2);
                        $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                        $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                        $TotalT = mysql_fetch_array($resT) ;
                        $result='4<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
                      }
                    }
                    
                }
                else if($ligne['classe']==0){
                  if($design['forme']!='Transaction'){
                    $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",1)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
                      $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
                    }
                  }
                  
              }
            }
            
        }
        else{
            if($design['forme']=='Transaction'){
              /*  $reqT="SELECT * from `aaa-transaction` where idTransaction='".$design['description']."'";
                $resT=mysql_query($reqT) or die ("select stock impossible =>".mysql_error());
                $transaction = mysql_fetch_array($resT);
                $image=$transaction['aliasTransaction'];
                $trans_alias=$transaction['aliasTransaction'];
                $trans_pagnet=$idPagnet;
                $msg_transaction="OK";*/
            }
            else{
              $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",1)";
              $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

              $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
              $res2=mysql_query($sql2);
              if(mysql_num_rows($res2)){
                $ligne=mysql_fetch_assoc($res2);
                $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                $TotalT = mysql_fetch_array($resT) ;
                $result='4<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
              }
            }
        }
    }
    if($design['classe']==2){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and classe=2 ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixPublic'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite=".$quantite.",prixtotal=".$prixTotal." where idPagnet=".$idPagnet." and idDesignation=".$design['idDesignation'];
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());

                $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                $res2=mysql_query($sql2);
                if(mysql_num_rows($res2)){
                  $ligne=mysql_fetch_assoc($res2);
                  $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                  $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                  $TotalT = mysql_fetch_array($resT) ;
                  $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$quantite;
                }
            }
            else {
                if($ligne['classe']==2){
                  $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",2)";
                  $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                  $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                  $res2=mysql_query($sql2);
                  if(mysql_num_rows($res2)){
                    $ligne=mysql_fetch_assoc($res2);
                    $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                    $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                    $TotalT = mysql_fetch_array($resT) ;
                    $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
                  }
                }
            }
        }
        else{
          $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",2)";
          $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

          $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
          $res2=mysql_query($sql2);
          if(mysql_num_rows($res2)){
            $ligne=mysql_fetch_assoc($res2);
            $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
            $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
            $TotalT = mysql_fetch_array($resT) ;
            $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
          }
        }
    }
    if($design['classe']==9){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and classe=9 ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){

            }
            else {
                if($ligne['classe']==9){
                  $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",9)";
                  $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                  $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                  $res2=mysql_query($sql2);
                  if(mysql_num_rows($res2)){
                    $ligne=mysql_fetch_assoc($res2);
                    $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                    $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                    $TotalT = mysql_fetch_array($resT) ;
                    $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0];
                  }
                }
            }
        }
        else{
          $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idPagnet.",9)";
          $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

          $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
          $res2=mysql_query($sql2);
          if(mysql_num_rows($res2)){
            $ligne=mysql_fetch_assoc($res2);
            $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
            $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
            $TotalT = mysql_fetch_array($resT) ;
            $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$ligne['classe'];
          }
        }
    }
  }
  exit($result);
}
if($operation == 7){

  $idPagnet=@htmlspecialchars($_POST["idPagnet"]);
  $numligne=@htmlspecialchars($_POST["numligne"]);
  $result="0";
  $sql1="SELECT * from  `".$nomtableLigne."` WHERE numligne='".$numligne."' ";
  $res1=mysql_query($sql1);
  if(mysql_num_rows($res1)){
      $ligne=mysql_fetch_assoc($res1);
      $sql7="DELETE FROM `".$nomtableLigne."` where numligne='".$numligne."' ";
      $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
      $TotalT = mysql_fetch_array($resT) ;
      $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['forme'].'<>'.$ligne['prixPublic'].'<>'.$numligne.'<>'.$TotalT[0];
  }
  exit($result);
}
if($operation == 8){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));

  if (($_SESSION['type']=="Pharmacie") && ($_SESSION['categorie']=="Detaillant")) {
    if($_SESSION['proprietaire']==1){
      $sqlV="SELECT DISTINCT d.designation
        FROM `".$nomtableDesignation."` d
        INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
        INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
        WHERE p.idClient=0  && p.verrouiller=1 && p.datepagej ='".$dateString2."'  && p.type=0 && d.designation LIKE '%$query%'  ";
      $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());
    }
    else{
      $sqlV="SELECT DISTINCT d.designation
        FROM `".$nomtableDesignation."` d
        INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
        INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
        WHERE p.iduser='".$_SESSION['iduser']."' && p.idClient=0  && p.verrouiller=1 && p.datepagej ='".$dateString2."'  && p.type=0 && d.designation LIKE '%$query%'  ";
      $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());
    }
  }
  else{
    $sqlV="SELECT DISTINCT d.designation
      FROM `".$nomtableDesignation."` d
      INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
      INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
      WHERE p.idClient=0  && p.verrouiller=1 && p.datepagej ='".$dateString2."'  && p.type=0 && d.designation LIKE '%$query%'  ";
    $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());
  }

  if($resV){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resV)) {
        $reponse.="<li class='liV'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
      }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 9){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $date_jour=@htmlspecialchars($_POST["date_jour"]);

  if (($_SESSION['type']=="Pharmacie") && ($_SESSION['categorie']=="Detaillant")) {
    if($_SESSION['proprietaire']==1){
      $sqlV="SELECT DISTINCT d.designation
        FROM `".$nomtableDesignation."` d
        INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
        INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
        WHERE p.idClient=0  && p.verrouiller=1 && p.datepagej ='".$date_jour."'  && p.type=0 && d.designation LIKE '%$query%'  ";
      $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());
    }
    else{
      $sqlV="SELECT DISTINCT d.designation
        FROM `".$nomtableDesignation."` d
        INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
        INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
        WHERE p.iduser='".$_SESSION['iduser']."' && p.idClient=0  && p.verrouiller=1 && p.datepagej ='".$date_jour."'  && p.type=0 && d.designation LIKE '%$query%'  ";
      $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());
    }
  }
  else{
    $sqlV="SELECT DISTINCT d.designation
      FROM `".$nomtableDesignation."` d
      INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
      INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
      WHERE p.idClient=0  && p.verrouiller=1 && p.datepagej ='".$date_jour."'  && p.type=0 && d.designation LIKE '%$query%'  ";
    $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());
  }

  if($resV){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resV)) {
        if (($_SESSION['type']=="Pharmacie") && ($_SESSION['categorie']=="Detaillant")) {
          $reponse.="<li class='liVapPh'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
        }
        else{
          $reponse.="<li class='liVap'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
        }
      }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 10){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $idClient=@htmlspecialchars($_POST["idClient"]);

  $sqlV="SELECT DISTINCT d.designation
    FROM `".$nomtableDesignation."` d
    INNER JOIN `".$nomtableLigne."` l ON l.idDesignation = d.idDesignation
    INNER JOIN `".$nomtablePagnet."` p ON p.idPagnet = l.idPagnet
    WHERE p.idClient='".$idClient."'  && p.verrouiller=1 && p.type=0 && d.designation LIKE '%$query%'  ";
  $resV = mysql_query($sqlV) or die ("persoonel requête 2".mysql_error());

  if($resV){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resV)) {
          $reponse.="<li class='liB'  style='background-color: #abdbb7; '>".$data['designation']." </li>";
      }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 11){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `aaa-catalogue-Pharmacie-Detaillant` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

  if($resS){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resS)) {
        $reponse.="<li class='liD'  style='background-color: #abdbb7; '>".$data['designation']." </li>";   
      }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 12){
  $designation=@htmlspecialchars($_POST["designation"]);
  $sql3='SELECT * from  `aaa-catalogue-Pharmacie-Detaillant` where designation="'.$designation.'" ';
  $res3=mysql_query($sql3);
  if($design=mysql_fetch_array($res3)){
    $result='1<>'.$design['idFusion'].'<>'.$design['designation'].'<>'.$design['categorie'].'<>'.$design['forme'].'<>'.$design['tableau'].'<>'.$design['prixSession'].'<>'.$design['prixPublic'].'<>'.$design['codeBarreDesignation'];
  }
  else{
    $result="0";
  }
  exit($result);
}
if($operation == 13){
  $source = [];
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

    if($resS){
        while ($data=mysql_fetch_array($resS)) {
              if(($data['uniteStock']=='Transaction' || $data['uniteStock']=='Credit')  && $data['seuil']==1){
                $source[] = $data['designation'];
              }
              if($data['uniteStock']!='Transaction' && $data['uniteStock']!='Facture' && $data['uniteStock']!='Credit'){
                  if($data['classe']==0){ 
                    $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableEntrepotStock."` where idDesignation='".$data['idDesignation']."' ";
                    $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                    $t_stock = mysql_fetch_array($res_t) ;
                    if($t_stock[0]>0){
                      $source[] = $data['designation']." => ".($t_stock[0] / $data['nbreArticleUniteStock']);
                    }        
                  }
                  if($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                    if($data['classe']==6){
                      $source[] = $data['designation'];
                     }
                  }
                  if ($_SESSION['enConfiguration']==0){
                    if($data['classe']==9){
                      $source[] = $data['designation'];
                    }
                  }
                  if($data['classe']==2){
                    $source[] = $data['designation'];
                  }
                  if ($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
                    if($data['classe']==8){
                      $source[] = $data['designation'];
                    }
                  }
                  if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                    if($data['classe']==10){
                      $source[] = $data['designation'];
                    }
                  }
                }
            }
    }
  echo json_encode($source);
}
if($operation == 14){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableFacture."` where prenom LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

    if($resS){
      $reponse="<ul class='ulc'>";
        while ($data=mysql_fetch_array($resS)) {
               $reponse.="<li class='lifET'>".$data['prenom']."<>".$data['nom']."<>".$data['adresse']."<>".$data['telephone']."</li>";
          }
      $reponse.="</ul>";
    }
  exit($reponse);
}
if($operation == 15){
  //$reponse+=sizeof($codeBrute);
  $designation=@htmlspecialchars($_POST["designation"]);
  $idPagnet=@htmlspecialchars($_POST["idPagnet"]);
  $result="0";

  $sql0="SELECT * FROM `".$nomtablePagnet."` where idPagnet=".$idPagnet." ";
  $res0 = mysql_query($sql0) or die ("persoonel requête 2".mysql_error());
  $pagnet = mysql_fetch_assoc($res0) ;

  $sql="SELECT * FROM `".$nomtableDesignation."` where (codeBarreDesignation='".$designation."' or codeBarreuniteStock='".$designation."' or designation='".$designation."') ";
  $res=mysql_query($sql) or die ("select stock impossible =>".mysql_error());
  if(mysql_num_rows($res)){
    $design = mysql_fetch_assoc($res);
    if($design['classe']==0){
        if($pagnet['type']==0 || $pagnet['type']==10){
          $sql_t="SELECT * FROM `".$nomtableStock."` where idDesignation='".$design['idDesignation']."'  ";
          $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
          if(mysql_num_rows($res_t)){
            $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$design['idDesignation']."' ";
            $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
            $t_stock = mysql_fetch_array($res_t) ;
            $restant = $t_stock[0];
            //if($restant>0){
                /***Debut verifier si la ligne du produit existe deja ***/
                $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and (unitevente='Article' or  unitevente='article') and classe=0 ";
                $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                $ligne1 = mysql_fetch_assoc($res);
                /***Debut verifier si la ligne du produit existe deja ***/
                if($ligne1 != null){
                    /***Debut verifier si le produit existe deja ***/
                    $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."'  and  unitevente!='Article' and  unitevente!='article' and classe=0 ";
                    $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                    $ligne2 = mysql_fetch_assoc($res);
                    /***Debut verifier si le produit existe deja ***/
                    $existant=0;
                    if($ligne2 != null){
                        $existant=$ligne2['quantite']*$design['nbreArticleUniteStock'];
                    }
                    $quantite = $ligne1['quantite'] + 1;
                    $reste = $t_stock[0] - $quantite - $existant;
                    if ($reste>=0){
                        $prixTotal=$quantite*$ligne1['prixunitevente'];
                        $sql7="UPDATE `".$nomtableLigne."` set quantite='".$quantite."',prixtotal=".$prixTotal." where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and (unitevente='Article' or  unitevente='article') and classe=0 ";
                        $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error()); 

                        $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                        $res2=mysql_query($sql2);
                        if(mysql_num_rows($res2)){
                          $ligne=mysql_fetch_assoc($res2);
                          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                          $TotalT = mysql_fetch_array($resT) ;

                          $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                          $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                          $t_stock = mysql_fetch_array($res_t) ;
                          $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$quantite;
                        }
                    }
                    else{
                      $result='3<>0';
                    }                     
                }
                else {
                    $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
                    $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                    $ligne = mysql_fetch_assoc($res) ;
                    if(mysql_num_rows($res)){
                        if($ligne['classe']==0 || $ligne['classe']==1){
                            $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','article',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",0)";
                            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 

                            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                            $res2=mysql_query($sql2);
                            if(mysql_num_rows($res2)){
                              $ligne=mysql_fetch_assoc($res2);
                              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                              $TotalT = mysql_fetch_array($resT) ;

                              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                              $t_stock = mysql_fetch_array($res_t) ;
                              if (($_SESSION['type']=="Divers") && ($_SESSION['categorie']=="Detaillant")) {
                                $result='10<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                              }
                              else{
                                $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                              }
                              
                            }
                        }
                    }
                    else{
                        $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','article',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",0)";
                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                        $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                            $res2=mysql_query($sql2);
                            if(mysql_num_rows($res2)){
                              $ligne=mysql_fetch_assoc($res2);
                              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                              $TotalT = mysql_fetch_array($resT) ;

                              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                              $t_stock = mysql_fetch_array($res_t) ;
                              if (($_SESSION['type']=="Divers") && ($_SESSION['categorie']=="Detaillant")) {
                                $result='10<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                              }
                              else{
                                $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                              }
                              
                            }
                    }
                
                }
            //}
            //else{
            //  $result='3<>0';
            //}
          }
        }
        else if($pagnet['type']==20){
          $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','article',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",0)";
          $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
          if($res7){
            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            $ligne=mysql_fetch_assoc($res2);
            if($design['codeBarreDesignation']!='' && $design['codeBarreDesignation']!=null){
              $result='8<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['codeBarreDesignation'].'<>'.$design['prix'].'<>'.$ligne['numligne'];
            }
            else{
              $result='8<>'.$design['idDesignation'].'<>'.$design['designation'].'<>Neant<>'.$design['prix'].'<>'.$ligne['numligne'];
            }
          }
        }
        else{
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and (unitevente='Article' or  unitevente='article') and classe=0 ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixunitevente'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite='".$quantite."',prixtotal=".$prixTotal." where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and (unitevente='Article' or  unitevente='article') and classe=0 ";
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());
            }
            else {
                $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
                $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                $ligne = mysql_fetch_assoc($res) ;
                if(mysql_num_rows($res)){
                    if($ligne['classe']==0){
                        $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','article',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",0)";
                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 
                    }
                }
                else{
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','article',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",0)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
                }

            }
        }
    }
    if($design['classe']==1 && ($pagnet['type']==0 || $pagnet['type']==10)){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=1  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixunitevente'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite='".$quantite."',prixtotal=".$prixTotal." where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=1  ";
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());

                $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                $res2=mysql_query($sql2);
                if(mysql_num_rows($res2)){
                  $ligne=mysql_fetch_assoc($res2);
                  $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                  $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                  $TotalT = mysql_fetch_array($resT) ;

                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  $t_stock = mysql_fetch_array($res_t) ;
                  $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$quantite;
                }
            }
            else {
                if($ligne['classe']==1){
                    if($design['uniteStock']!='Transaction'){
                        $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."','".$design['idDesignation']."','".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",1)";
                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                        $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                        $res2=mysql_query($sql2);
                        if(mysql_num_rows($res2)){
                          $ligne=mysql_fetch_assoc($res2);
                          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                          $TotalT = mysql_fetch_array($resT) ;

                          $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                          $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                          $t_stock = mysql_fetch_array($res_t) ;
                          $result='4<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                        }
                    }
                    
                }
                else if($ligne['classe']==0){
                  if($design['uniteStock']!='Transaction'){
                      $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."','".$design['idDesignation']."','".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",1)";
                      $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                      $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                      $res2=mysql_query($sql2);
                      if(mysql_num_rows($res2)){
                        $ligne=mysql_fetch_assoc($res2);
                        $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                        $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                        $TotalT = mysql_fetch_array($resT) ;

                        $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                        $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                        $t_stock = mysql_fetch_array($res_t) ;
                        $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                      }
                  }
                  
              }
                
            }
            
        }
        else{
            if($design['uniteStock']=='Transaction'){
                $reqT="SELECT * from `aaa-transaction` where idTransaction='".$design['description']."'";
                $resT=mysql_query($reqT) or die ("select stock impossible =>".mysql_error());
                $transaction = mysql_fetch_assoc($resT);
                $image=$transaction['aliasTransaction'];
                $trans_alias=$transaction['aliasTransaction'];
                $trans_pagnet=$idPagnet;
                $msg_transaction="OK";
            }
            else if($design['uniteStock']=='Credit'){
                $reqT="SELECT * from `aaa-transaction` where idTransaction='".$design['description']."'";
                $resT=mysql_query($reqT) or die ("select stock impossible =>".mysql_error());
                $transaction = mysql_fetch_assoc($resT);
                $image=$transaction['aliasTransaction'];
                $trans_alias=$transaction['aliasTransaction'];
                $trans_pagnet=$idPagnet;
                $msg_credit="OK";
            }
            else{
                
                $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",1)";
                $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                $res2=mysql_query($sql2);
                if(mysql_num_rows($res2)){
                  $ligne=mysql_fetch_assoc($res2);
                  $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                  $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                  $TotalT = mysql_fetch_array($resT) ;

                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  $t_stock = mysql_fetch_array($res_t) ;
                  $result='4<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                }
            }
        }
    }
    if($design['classe']==2 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idStock='".$design['idDesignation']."' and classe=2  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
               
            }
            else {
                if($ligne['classe']==2){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",2)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;

                      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                      $t_stock = mysql_fetch_array($res_t) ;
                      $result='7<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                    }
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",2)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            if(mysql_num_rows($res2)){
              $ligne=mysql_fetch_assoc($res2);
              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
              $TotalT = mysql_fetch_array($resT) ;

              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
              $t_stock = mysql_fetch_array($res_t) ;
              $result='7<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
            }
        }
    }
    if($design['classe']==5 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=5  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==5){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",5)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
        
                      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                      $t_stock = mysql_fetch_array($res_t) ;
                      $result='5<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                    }
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",5)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            if(mysql_num_rows($res2)){
              $ligne=mysql_fetch_assoc($res2);
              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
              $TotalT = mysql_fetch_array($resT) ;

              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
              $t_stock = mysql_fetch_array($res_t) ;
              $result='5<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
            }
        }
    }
    if($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
      if($design['classe']==6 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=7  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==6){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",6)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
        
                      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                      $t_stock = mysql_fetch_array($res_t) ;
                      $result='7<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                    }
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",6)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            if(mysql_num_rows($res2)){
              $ligne=mysql_fetch_assoc($res2);
              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
              $TotalT = mysql_fetch_array($resT) ;

              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
              $t_stock = mysql_fetch_array($res_t) ;
              $result='7<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
            }
        }
      }
      else if($design['classe']==9 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=7  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==9){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",9)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
        
                      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                      $t_stock = mysql_fetch_array($res_t) ;$result='6<>0';
                    }
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",9)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            if(mysql_num_rows($res2)){
              $ligne=mysql_fetch_assoc($res2);
              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
              $TotalT = mysql_fetch_array($resT) ;

              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
              $t_stock = mysql_fetch_array($res_t) ;
              $result='6<>0';
            }
        }
      }
    }
    if($design['classe']==7 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=7  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==7){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",7)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
        
                      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                      $t_stock = mysql_fetch_array($res_t) ;
                      $result='5<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                    }
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",7)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            if(mysql_num_rows($res2)){
              $ligne=mysql_fetch_assoc($res2);
              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
              $TotalT = mysql_fetch_array($resT) ;

              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
              $t_stock = mysql_fetch_array($res_t) ;
              $result='5<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
            }
        }
    }
    if($design['classe']==8){
        $sql3="UPDATE `".$nomtablePagnet."` set type='1' where idPagnet=".$idPagnet;
        $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
        $result='6<>0';
    }
    if($design['classe']==10){
        $sql3="UPDATE `".$nomtablePagnet."` set type='10' where idPagnet=".$idPagnet;
        $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
        $result='6<>0';
    }
    if($design['classe']==20){
      $sql3="UPDATE `".$nomtablePagnet."` set type='20' where idPagnet=".$idPagnet;
      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
      $result='6<>0';
    }
  }



  exit($result);
}
if($operation == 16){

  $idPagnet=@htmlspecialchars($_POST["idPagnet"]);
  $numligne=@htmlspecialchars($_POST["numligne"]);
  $result="0";
  $sql1="SELECT * from  `".$nomtableLigne."` WHERE numligne='".$numligne."' ";
  $res1=mysql_query($sql1);
  if(mysql_num_rows($res1)){
      $ligne=mysql_fetch_assoc($res1);
      $sql7="DELETE FROM `".$nomtableLigne."` where numligne='".$numligne."' ";
      $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
      $TotalT = mysql_fetch_array($resT) ;
      $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['unitevente'].'<>'.$ligne['prixunitevente'].'<>'.$numligne.'<>'.$TotalT[0];
  }
  exit($result);
}
if($operation == 17){
  //$reponse+=sizeof($codeBrute);
  $designation=@htmlspecialchars($_POST["designation"]);
  $idPagnet=@htmlspecialchars($_POST["idPagnet"]);
  $result="0";

  $sql0="SELECT * FROM `".$nomtablePagnet."` where idPagnet=".$idPagnet." ";
  $res0 = mysql_query($sql0) or die ("persoonel requête 2".mysql_error());
  $pagnet = mysql_fetch_assoc($res0) ;

  $sql="SELECT * FROM `".$nomtableDesignation."` where (codeBarreDesignation='".$designation."' or codeBarreuniteStock='".$designation."' or designation='".$designation."') ";
  $res=mysql_query($sql) or die ("select stock impossible =>".mysql_error());
  if(mysql_num_rows($res)){
    $design = mysql_fetch_assoc($res);
    
    if($design['classe']==0){
        if($pagnet['type']==0){
            $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$design['idDesignation']."' ";
            $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
            $t_stock = mysql_fetch_array($res_t) ;
            $restant = $t_stock[0];
            if($restant>0){
                /***Debut verifier si la ligne du produit existe deja ***/
                $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=0 ";
                $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                $ligne = mysql_fetch_assoc($res);
                /***Debut verifier si la ligne du produit existe deja ***/
                if($ligne != null){
                    $reqP="SELECT * from  `".$nomtableEntrepotStock."` 
                    where idDesignation='".$design['idDesignation']."' AND quantiteStockCourant>0 AND idEntrepot!='".$ligne['idEntrepot']."' ";
                    $resP=mysql_query($reqP) or die ("select stock impossible =>".mysql_error());
                    if(mysql_num_rows($resP)){
                        $entrepot = mysql_fetch_assoc($resP);  
                        /***Debut verifier si la ligne du produit existe deja ***/
                        $sql1="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' AND idEntrepot='".$entrepot['idEntrepot']."'  and classe=0 ";
                        $res1 = mysql_query($sql1) or die ("persoonel requête 2".mysql_error());
                        $ligne1 = mysql_fetch_assoc($res1);
                        /***Debut verifier si la ligne du produit existe deja ***/
                        if($ligne1 != null){
                            
                        }
                        else{
                            $reqP1="SELECT * from  `".$nomtableEntrepotStock."` 
                            where idDesignation='".$design['idDesignation']."' AND quantiteStockCourant>0 AND idEntrepot!='".$ligne['idEntrepot']."' AND idEntrepot!='".$ligne1['idEntrepot']."'  ";
                            $resP1=mysql_query($reqP1) or die ("select stock impossible =>".mysql_error());
                            $produit = mysql_fetch_assoc($resP1);
                                if(mysql_num_rows($resP1)){
                                    if($ligne['classe']==0){
                                        $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','".$produit['idEntrepot']."','".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 
                                        $result='2<>0';
                                        
                                    }
                                }
                        }
                    }
                    
                }
                else{
                    $sqlN="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
                    $resN = mysql_query($sqlN) or die ("persoonel requête 2".mysql_error());
                    $ligneN = mysql_fetch_assoc($resN) ;
                    if($_SESSION['entrepot']!=0 || $_SESSION['entrepot']!=null){
                        $reqP="SELECT * from  `".$nomtableEntrepotStock."` 
                        where idDesignation='".$design['idDesignation']."' AND quantiteStockCourant>0  AND idEntrepot='".$_SESSION['entrepot']."' ";
                        $resP=mysql_query($reqP) or die ("select stock impossible =>".mysql_error());
                        if(mysql_num_rows($resP)){
                            $entrepot = mysql_fetch_assoc($resP);
                            if($ligneN['classe']==0 || $ligneN['classe']==1){
                                $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','".$entrepot['idEntrepot']."','".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                                $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 

                                $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                                $res2=mysql_query($sql2);
                                if(mysql_num_rows($res2)){
                                  $ligne=mysql_fetch_assoc($res2);
      
                                  $sqlE="SELECT * from `".$nomtableEntrepot."`  WHERE idEntrepot='".$ligne['idEntrepot']."' ";
                                  $resE=mysql_query($sqlE);
                                  $ligne_Dep = mysql_fetch_assoc($resE);
      
                                  /***Debut verifier si la ligne du produit existe deja ***/
                                  $sqlEl="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$ligne['idDesignation']."' and idEntrepot!='".$ligne['idEntrepot']."'";
                                  $resEl = mysql_query($sqlEl) or die ("persoonel requête 2".mysql_error());
                                  /***Debut verifier si la ligne du produit existe deja ***/
                                  if(!mysql_num_rows($resEl)){
                                      $reqDp="SELECT * from  `".$nomtableEntrepot."` e
                                      INNER JOIN `".$nomtableEntrepotStock."` s ON s.idEntrepot = e.idEntrepot
                                      where s.designation='".$ligne['designation']."' AND s.quantiteStockCourant>0 AND e.idEntrepot<>'".$ligne["idEntrepot"]."' ORDER BY quantiteStockCourant DESC ";
                                      $resDp=mysql_query($reqDp) or die ("select stock impossible =>".mysql_error());
                                      $data=array();
                                      $data_distinct=array();
                                      while ($depot_Et = mysql_fetch_assoc($resDp)) {
                                        if(in_array($depot_Et['idEntrepot'], $data_distinct)){
                                          // echo "Existe.";
                                        }
                                        else{
                                          $rows = array();	
                                          $rows[] = $depot_Et['idEntrepot'];
                                          $rows[] = $depot_Et['nomEntrepot'];
                                          $data[] = $rows;
                                          $data_distinct[] = $depot_Et['idEntrepot'];
                                        }
                                      }
                                  }
      
                                  $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                                  $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                                  $TotalT = mysql_fetch_array($resT) ;
      
                                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                                  $t_stock = mysql_fetch_array($res_t) ;
                                  
                                  $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prixuniteStock'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0].'<>'.$ligne_Dep['idEntrepot'].'<>'.$ligne_Dep['nomEntrepot'].'<>'.json_encode($data);
                                }
                            }
                        }
                        else{
                            $reqP1="SELECT * from  `".$nomtableEntrepotStock."` 
                            where idDesignation='".$design['idDesignation']."' AND quantiteStockCourant>0 ORDER BY quantiteStockCourant DESC LIMIT 0,1 ";
                            $resP1=mysql_query($reqP1) or die ("select stock impossible =>".mysql_error());
                            $depot = mysql_fetch_assoc($resP1);
                            $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','".$depot['idEntrepot']."','".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                            $res2=mysql_query($sql2);
                            if(mysql_num_rows($res2)){
                              $ligne=mysql_fetch_assoc($res2);

                              $sqlE="SELECT * from `".$nomtableEntrepot."`  WHERE idEntrepot='".$ligne['idEntrepot']."' ";
                              $resE=mysql_query($sqlE);
                              $ligne_Dep = mysql_fetch_assoc($resE);

                              /***Debut verifier si la ligne du produit existe deja ***/
                              $sqlEl="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$ligne['idDesignation']."' and idEntrepot!='".$ligne['idEntrepot']."'";
                              $resEl = mysql_query($sqlEl) or die ("persoonel requête 2".mysql_error());
                              /***Debut verifier si la ligne du produit existe deja ***/
                              if(!mysql_num_rows($resEl)){
                                  $reqDp="SELECT * from  `".$nomtableEntrepot."` e
                                  INNER JOIN `".$nomtableEntrepotStock."` s ON s.idEntrepot = e.idEntrepot
                                  where s.designation='".$ligne['designation']."' AND s.quantiteStockCourant>0 AND e.idEntrepot<>'".$ligne["idEntrepot"]."' ORDER BY quantiteStockCourant DESC ";
                                  $resDp=mysql_query($reqDp) or die ("select stock impossible =>".mysql_error());
                                  $data=array();
                                  $data_distinct=array();
                                  while ($depot_Et = mysql_fetch_assoc($resDp)) {
                                    if(in_array($depot_Et['idEntrepot'], $data_distinct)){
                                      // echo "Existe.";
                                    }
                                    else{
                                      $rows = array();	
                                      $rows[] = $depot_Et['idEntrepot'];
                                      $rows[] = $depot_Et['nomEntrepot'];
                                      $data[] = $rows;
                                      $data_distinct[] = $depot_Et['idEntrepot'];
                                    }
                                  }
                              }

                              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                              $TotalT = mysql_fetch_array($resT) ;

                              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                              $t_stock = mysql_fetch_array($res_t) ;
                              
                              $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prixuniteStock'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0].'<>'.$ligne_Dep['idEntrepot'].'<>'.$ligne_Dep['nomEntrepot'].'<>'.json_encode($data);
                            }
                        }
                    }
                    else{
                        $reqP="SELECT * from  `".$nomtableEntrepotStock."` 
                        where idDesignation='".$design['idDesignation']."' AND quantiteStockCourant>0 ORDER BY quantiteStockCourant DESC LIMIT 0,1 ";
                        $resP=mysql_query($reqP) or die ("select stock impossible =>".mysql_error());
                        if(mysql_num_rows($resP)){
                            $entrepot = mysql_fetch_assoc($resP);
                            if($ligneN['classe']==0){
                                $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','".$entrepot['idEntrepot']."','".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                                $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 

                                $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                                $res2=mysql_query($sql2);
                                if(mysql_num_rows($res2)){
                                  $ligne=mysql_fetch_assoc($res2);
      
                                  $sqlE="SELECT * from `".$nomtableEntrepot."`  WHERE idEntrepot='".$ligne['idEntrepot']."' ";
                                  $resE=mysql_query($sqlE);
                                  $ligne_Dep = mysql_fetch_assoc($resE);
      
                                  /***Debut verifier si la ligne du produit existe deja ***/
                                  $sqlEl="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$ligne['idDesignation']."' and idEntrepot!='".$ligne['idEntrepot']."'";
                                  $resEl = mysql_query($sqlEl) or die ("persoonel requête 2".mysql_error());
                                  /***Debut verifier si la ligne du produit existe deja ***/
                                  if(!mysql_num_rows($resEl)){
                                      $reqDp="SELECT * from  `".$nomtableEntrepot."` e
                                      INNER JOIN `".$nomtableEntrepotStock."` s ON s.idEntrepot = e.idEntrepot
                                      where s.designation='".$ligne['designation']."' AND s.quantiteStockCourant>0 AND e.idEntrepot<>'".$ligne["idEntrepot"]."' ORDER BY quantiteStockCourant DESC ";
                                      $resDp=mysql_query($reqDp) or die ("select stock impossible =>".mysql_error());
                                      $data=array();
                                      $data_distinct=array();
                                      while ($depot_Et = mysql_fetch_assoc($resDp)) {
                                        if(in_array($depot_Et['idEntrepot'], $data_distinct)){
                                          // echo "Existe.";
                                        }
                                        else{
                                          $rows = array();	
                                          $rows[] = $depot_Et['idEntrepot'];
                                          $rows[] = $depot_Et['nomEntrepot'];
                                          $data[] = $rows;
                                          $data_distinct[] = $depot_Et['idEntrepot'];
                                        }
                                      }
                                  }
      
                                  $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                                  $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                                  $TotalT = mysql_fetch_array($resT) ;
      
                                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                                  $t_stock = mysql_fetch_array($res_t) ;
                                  
                                  $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prixuniteStock'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0].'<>'.$ligne_Dep['idEntrepot'].'<>'.$ligne_Dep['nomEntrepot'].'<>'.json_encode($data);
                                }
                            }
                        }
                        else{
                            $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."','".$entrepot['idEntrepot']."','".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                            $res2=mysql_query($sql2);
                            if(mysql_num_rows($res2)){
                              $ligne=mysql_fetch_assoc($res2);

                              $sqlE="SELECT * from `".$nomtableEntrepot."`  WHERE idEntrepot='".$ligne['idEntrepot']."' ";
                              $resE=mysql_query($sqlE);
                              $ligne_Dep = mysql_fetch_assoc($resE);

                              /***Debut verifier si la ligne du produit existe deja ***/
                              $sqlEl="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$ligne['idDesignation']."' and idEntrepot!='".$ligne['idEntrepot']."'";
                              $resEl = mysql_query($sqlEl) or die ("persoonel requête 2".mysql_error());
                              /***Debut verifier si la ligne du produit existe deja ***/
                              if(!mysql_num_rows($resEl)){
                                  $reqDp="SELECT * from  `".$nomtableEntrepot."` e
                                  INNER JOIN `".$nomtableEntrepotStock."` s ON s.idEntrepot = e.idEntrepot
                                  where s.designation='".$ligne['designation']."' AND s.quantiteStockCourant>0 AND e.idEntrepot<>'".$ligne["idEntrepot"]."' ORDER BY quantiteStockCourant DESC ";
                                  $resDp=mysql_query($reqDp) or die ("select stock impossible =>".mysql_error());
                                  $data=array();
                                  $data_distinct=array();
                                  while ($depot_Et = mysql_fetch_assoc($resDp)) {
                                    if(in_array($depot_Et['idEntrepot'], $data_distinct)){
                                      // echo "Existe.";
                                    }
                                    else{
                                      $rows = array();	
                                      $rows[] = $depot_Et['idEntrepot'];
                                      $rows[] = $depot_Et['nomEntrepot'];
                                      $data[] = $rows;
                                      $data_distinct[] = $depot_Et['idEntrepot'];
                                    }
                                  }
                              }

                              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                              $TotalT = mysql_fetch_array($resT) ;

                              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                              $t_stock = mysql_fetch_array($res_t) ;
                              
                              $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prixuniteStock'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0].'<>'.$ligne_Dep['idEntrepot'].'<>'.$ligne_Dep['nomEntrepot'].'<>'.json_encode($data);
                            }
                        }
                    }
                }
            }
            else{
              $result='3<>0';
            }
        }
        else{
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and designation='".$design['designation']."' and (unitevente='Article' or  unitevente='article') and classe=0 ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixunitevente'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite='".$quantite."',prixtotal=".$prixTotal." where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and (unitevente='Article' or  unitevente='article') and classe=0 ";
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());
            }
            else {
                $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
                $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                $ligne = mysql_fetch_assoc($res) ;
                if(mysql_num_rows($res)){
                    if($ligne['classe']==0){
                        $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."',0,'".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 
                    
                    }
                }
                else{
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock, idDesignation,idEntrepot, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',0,'".$design['idDesignation']."',0,'".$design['uniteStock']."',".$design['prixuniteStock'].",1,".$design['prixuniteStock'].",".$idPagnet.",0)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() ); 
                
                }

            }  
        }
    }
    if($design['classe']==1 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=1  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixunitevente'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite='".$quantite."',prixtotal=".$prixTotal." where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=1  ";
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());
                $result='2<>0';
            }
            else {
                if($ligne['classe']==1 || $ligne['classe']==0){
                    if($design['uniteStock']!='Transaction'){
                        $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."','".$design['idDesignation']."','".$design['idDesignation']."','".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",1)";
                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
                        $result='2<>0';
                    }
                    
                }
                
            }
            
        }
        else{
            if($design['uniteStock']=='Transaction'){
                $reqT="SELECT * from `aaa-transaction` where idTransaction='".$design['description']."'";
                $resT=mysql_query($reqT) or die ("select stock impossible =>".mysql_error());
                $transaction = mysql_fetch_assoc($resT);
                $image=$transaction['aliasTransaction'];
                $trans_alias=$transaction['aliasTransaction'];
                $trans_pagnet=$idPagnet;
                $msg_transaction="OK";
            }
            else if($design['uniteStock']=='Credit'){
                $reqT="SELECT * from `aaa-transaction` where idTransaction='".$design['description']."'";
                $resT=mysql_query($reqT) or die ("select stock impossible =>".mysql_error());
                $transaction = mysql_fetch_assoc($resT);
                $image=$transaction['aliasTransaction'];
                $trans_alias=$transaction['aliasTransaction'];
                $trans_pagnet=$idPagnet;
                $msg_credit="OK";
            }
            else{
                
                $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",1)";
                $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
            }
        }
    }
    if($design['classe']==2 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idStock='".$design['idDesignation']."' and classe=2  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
                $quantite = $ligne1['quantite'] + 1;
                $prixTotal=$quantite*$ligne1['prixunitevente'];
                $sql7="UPDATE `".$nomtableLigne."` set quantite='".$quantite."',prixtotal=".$prixTotal." where idPagnet='".$idPagnet."' and idStock='".$design['idDesignation']."' and classe=2  ";
                $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());
                $result='2<>0';
            }
            else {
                if($ligne['classe']==2){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",2)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
                    $result='2<>0';
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",2)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
            $result='2<>0';
        }
    }
    if($design['classe']==5 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=5  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==5){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",5)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
                    $result='2<>0';
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",5)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
            $result='2<>0';
        }
    }
    if($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1){
      if($design['classe']==6 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=7  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==6){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",6)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
        
                      $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
                      $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                      $t_stock = mysql_fetch_array($res_t) ;
                      $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
                    }
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",6)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

            $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idPagnet='".$idPagnet."' ";
            $res2=mysql_query($sql2);
            if(mysql_num_rows($res2)){
              $ligne=mysql_fetch_assoc($res2);
              $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."'  ";
              $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
              $TotalT = mysql_fetch_array($resT) ;

              $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$ligne['idDesignation']."' ";
              $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
              $t_stock = mysql_fetch_array($res_t) ;
              $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$ligne['unitevente'].'<>'.$design['prix'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$design['uniteStock'].'<>'.$design['nbreArticleUniteStock'].'<>'.$t_stock[0];
            }
        }
      }
    }
    if($design['classe']==7 && $pagnet['type']==0){
        $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet=".$idPagnet." ";
        $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
        $ligne = mysql_fetch_assoc($res) ;
        if(mysql_num_rows($res)){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idPagnet='".$idPagnet."' and idDesignation='".$design['idDesignation']."' and classe=7  ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne1 = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne1 != null){
            }
            else {
                if($ligne['classe']==7){
                    $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",7)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
                    $result='2<>0';
                }
            }
        }
        else{
            $sql7="insert into `".$nomtableLigne."` (designation, idStock,idDesignation, unitevente,prixunitevente,quantite,prixtotal,idPagnet,classe)values('".$design['designation']."',".$design['idDesignation'].",".$design['idDesignation'].",'".$design['uniteStock']."',".$design['prix'].",1,".$design['prix'].",".$idPagnet.",7)";
            $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );
            $result='2<>0';
        }
    }
    if($design['classe']==8){
        $sql3="UPDATE `".$nomtablePagnet."` set type='1' where idPagnet=".$idPagnet;
        $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
        $result='2<>0';
    }
    if($design['classe']==10){
        $sql3="UPDATE `".$nomtablePagnet."` set type='10' where idPagnet=".$idPagnet;
        $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
        $result='2<>0';
    }

   
  }



  exit($result);
}
if($operation == 18){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableCategorie."` where nomcategorie LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

  if($resS){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resS)) {
        $reponse.="<li class='liC_Ph'  style='background-color: #abdbb7; '>".$data['nomcategorie']." </li>";   
      }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 19){
  //$reponse+=sizeof($codeBrute);
  $reponse="<ul><li>aucune donnee trouvé</li></ul>";
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT DISTINCT forme from `".$nomtableDesignation."` where forme LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");

  if($resS){
    $reponse="<ul class='ulc'>";
      while ($data=mysql_fetch_array($resS)) {
        $reponse.="<li class='liF_Ph'  style='background-color: #abdbb7; '>".$data['forme']." </li>";   
      }
    $reponse.="</ul>";
  }
  exit($reponse);
}
if($operation == 20){
  $source = [];
  $query=htmlspecialchars(trim($_POST['query']));
  $reqS="SELECT * from `".$nomtableDesignation."` where designation LIKE '%$query%' ";
  $resS=mysql_query($reqS) or die ("insertion impossible");
  if($resS){
      while ($data=mysql_fetch_array($resS)) {
            if($data['forme']!='Transaction' && $data['forme']!='Facture' && $data['forme']!='Credit'){
                if($data['classe']==0){
                  $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$data['idDesignation']."' ";
                  $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
                  $t_stock = mysql_fetch_array($res_t) ;
                  if($t_stock[0]>0){
                    $source[] = $data['designation']." => ".$t_stock[0];
                   }        
                }
                if($data['classe']==1){
                  $source[] = $data['designation'];
                 }
                if (($_SESSION['proprietaire']==1 || $_SESSION['gerant']==1) && $_SESSION['enConfiguration']==0){
                  if($data['classe']==9){
                    $source[] = $data['designation'];
                   }
                }
              }
          }
  }
  echo json_encode($source);
}
if($operation == 21){
  //$reponse+=sizeof($codeBrute);
  $designation=@htmlspecialchars($_POST["designation"]);
  $idMutuellePagnet=@htmlspecialchars($_POST["idMutuellePagnet"]);
  $result="0";
  $sqlMP="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
  $resMP = mysql_query($sqlMP) or die ("persoonel requête 2".mysql_error());
  if($resMP){
    $pagnet = mysql_fetch_assoc($resMP) ;
    $sql="SELECT * FROM `".$nomtableDesignation."` where (codeBarreDesignation='".$designation."' or codeBarreuniteStock='".$designation."' or designation='".$designation."') ";
    $res=mysql_query($sql) or die ("select stock impossible =>".mysql_error());
    if(mysql_num_rows($res)){
      $design = mysql_fetch_assoc($res);
      if($design['classe']==0){
        $sql_t="SELECT SUM(quantiteStockCourant) FROM `".$nomtableStock."` where idDesignation='".$design['idDesignation']."' ";
        $res_t=mysql_query($sql_t) or die ("select stock impossible =>".mysql_error());
        $t_stock = mysql_fetch_array($res_t) ;
        $restant = $t_stock[0];
        if($restant>0){
            /***Debut verifier si la ligne du produit existe deja ***/
            $sql="SELECT * FROM `".$nomtableLigne."` where idMutuellePagnet='".$idMutuellePagnet."' and designation='".$design['designation']."' and classe=0 ";
            $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
            $ligne = mysql_fetch_assoc($res);
            /***Debut verifier si la ligne du produit existe deja ***/
            if($ligne != null){
                $quantite = $ligne['quantite'] + 1;
                $reste = $t_stock[0] - $quantite;
                if ($reste>=0){
                    $prixTotal=$quantite*$ligne['prixPublic'];
                    $sql7="UPDATE `".$nomtableLigne."` set quantite=".$quantite.",prixtotal=".$prixTotal." where idMutuellePagnet=".$idMutuellePagnet." and idDesignation=".$design['idDesignation'];
                    $res7=mysql_query($sql7) or die ("update quantiteStockCourant impossible =>".mysql_error());

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idMutuellePagnet='".$idMutuellePagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet='".$idMutuellePagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
                      $result='2<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$quantite.'<>'.$pagnet['taux'];
                    }
                }
                else{
                    $result='3<>'.$t_stock[0];
                }                     
            }
            else {
                $sql="SELECT * FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
                $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
                $ligne = mysql_fetch_assoc($res) ;
                if(mysql_num_rows($res)){
                    if($ligne['classe']==0 || $ligne['classe']==1){
                        $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idMutuellePagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idMutuellePagnet.",0)";
                        $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                        $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idMutuellePagnet='".$idMutuellePagnet."' ";
                        $res2=mysql_query($sql2);
                        if(mysql_num_rows($res2)){
                          $ligne=mysql_fetch_assoc($res2);
                          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet='".$idMutuellePagnet."'  ";
                          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                          $TotalT = mysql_fetch_array($resT) ;
                          $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$pagnet['taux'];
                        }
                    }
                }
                else{
                    $sql7="insert into `".$nomtableLigne."`(designation,idDesignation,idStock, forme,prixPublic,quantite,prixtotal,idMutuellePagnet,classe)values('".$design['designation']."','".$design['idDesignation']."',0,'".$design['forme']."',".$design['prixPublic'].",1,".$design['prixPublic'].",".$idMutuellePagnet.",0)";
                    $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

                    $sql2="SELECT * from  `".$nomtableLigne."` WHERE designation='".$design['designation']."' AND idMutuellePagnet='".$idMutuellePagnet."' ";
                    $res2=mysql_query($sql2);
                    if(mysql_num_rows($res2)){
                      $ligne=mysql_fetch_assoc($res2);
                      $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet='".$idMutuellePagnet."'  ";
                      $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
                      $TotalT = mysql_fetch_array($resT) ;
                      $result='1<>'.$design['idDesignation'].'<>'.$design['designation'].'<>'.$design['forme'].'<>'.$design['prixPublic'].'<>'.$ligne['numligne'].'<>'.$TotalT[0].'<>'.$pagnet['taux'];
                    }
                }
            
            }
        }
        else{
          $result='3<>0';
        }
      }
    }
  }
  exit($result);
}
if($operation == 22){

  $idMutuellePagnet=@htmlspecialchars($_POST["idMutuellePagnet"]);
  $numligne=@htmlspecialchars($_POST["numligne"]);
  $result="0";
  $sqlMP="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
  $resMP = mysql_query($sqlMP) or die ("persoonel requête 2".mysql_error());
  if($resMP){
      $pagnet = mysql_fetch_assoc($resMP) ;
      $sql1="SELECT * from  `".$nomtableLigne."` WHERE numligne='".$numligne."' ";
      $res1=mysql_query($sql1);
      if(mysql_num_rows($res1)){
          $ligne=mysql_fetch_assoc($res1);
          $sql7="DELETE FROM `".$nomtableLigne."` where numligne='".$numligne."' ";
          $res7=mysql_query($sql7) or die ("insertion pagnier impossible 7  =>".mysql_error() );

          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet='".$idMutuellePagnet."'  ";
          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
          $TotalT = mysql_fetch_array($resT) ;
          $result='1<>'.$ligne['idDesignation'].'<>'.$ligne['designation'].'<>'.$ligne['forme'].'<>'.$ligne['prixPublic'].'<>'.$numligne.'<>'.$TotalT[0].'<>'.$pagnet['taux'];
      }
  }
  exit($result);
}
if($operation == 23){
  $source = [];
  $query=htmlspecialchars(trim($_POST['query']));

  $sqlC="SELECT * FROM `".$nomtableClient."` where prenom LIKE '%$query%' OR nom LIKE '%$query%' ";
  $resC = mysql_query($sqlC) or die ("persoonel requête 3".mysql_error());

  if($resC){
      while ($data=mysql_fetch_array($resC)) {
        $source[] = $data['prenom']." ".strtoupper($data['nom']);
      }
    $idMutuellePagnet=@$_POST['idMutuellePagnet'];
    $sqlM="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
    $resM = mysql_query($sqlM) or die ("persoonel requête 2".mysql_error());
    if($resM){
      $sql3="UPDATE `".$nomtableMutuellePagnet."` set adherant='".$query."' where idMutuellePagnet=".$idMutuellePagnet;
      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
    }
  }
  echo json_encode($source);
}
if($operation == 24){
  $client=@$_POST['client'];
  $idMutuellePagnet=@$_POST['idMutuellePagnet'];
  $reponse="0";
  $sqlM="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
  $resM = mysql_query($sqlM) or die ("persoonel requête 2".mysql_error());
  if($resM){
    $sql3="UPDATE `".$nomtableMutuellePagnet."` set adherant='".$client."' where idMutuellePagnet=".$idMutuellePagnet;
    $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
    $reponse="1";
  }
  exit($reponse);
}
if($operation == 25){
  $codeAdherant=@$_POST['codeAdherant'];
  $idMutuellePagnet=@$_POST['idMutuellePagnet'];
  $reponse="0";
  $sqlM="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
  $resM = mysql_query($sqlM) or die ("persoonel requête 2".mysql_error());
  if($resM){
    $sql3="UPDATE `".$nomtableMutuellePagnet."` set codeAdherant='".$codeAdherant."' where idMutuellePagnet=".$idMutuellePagnet;
    $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
    $reponse="1";
  }
  exit($reponse);
}
if($operation == 26){
  $clients = [];
  $query=htmlspecialchars(trim($_POST['query']));
  
  $sql3="SELECT * FROM `".$nomtableClient."` where prenom LIKE '%$query%' or nom LIKE '%$query%' or adresse LIKE '%$query%' ORDER BY idClient ASC";
  $res3 = mysql_query($sql3) or die ("persoonel requête 3".mysql_error());

  while($client = mysql_fetch_assoc($res3)){
      $clients[] = $client['idClient']." . ".$client['prenom']." ".$client['nom']." ".$client['adresse'];
  }
  
  echo json_encode($clients);
}

if($operation == 27){
  $idClient=htmlspecialchars(trim($_POST['idClient']));
  $idPanier=htmlspecialchars(trim($_POST['idPanier']));
  $dataType=htmlspecialchars(trim($_POST['typeData']));

  if ($dataType == 'simple') {
    $r = '';
    if ($idClient == '0') {
      $sql3="UPDATE `".$nomtablePagnet."` SET type=0, idCompte=0, idClient=".$idClient." where idPagnet='".$idPanier."'";
      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible 1--- ".mysql_error());
      $r = '1'.'/'.$idClient.'/'.$idPanier; 
    } else {
      $sql3="UPDATE `".$nomtablePagnet."` SET type=30, idCompte=2, idClient=".$idClient." where idPagnet='".$idPanier."'";
      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible 1--- ".mysql_error());     
      $r = '2'.'/'.$idClient.'/'.$idPanier; 
    }
  } else if ($dataType == 'mutuelle') {

    if ($idClient == '0') {
      $sql3="UPDATE `".$nomtableMutuellePagnet."` SET type=0, idCompte=0, idClient=".$idClient." where idMutuellePagnet='".$idPanier."'";
      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible 1--- ".mysql_error());
      $r = '3'.'/'.$idClient.'/'.$idPanier; 
    } else {
      $sql3="UPDATE `".$nomtableMutuellePagnet."` SET type=30, idCompte=2, idClient=".$idClient." where idMutuellePagnet='".$idPanier."'";
      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible 1--- ".mysql_error());
      $r = '4'.'/'.$idClient.'/'.$idPanier; 
    }
    
  }
  echo $r;
}
if($operation == 28){
  $msg_info='';
  $idMutuellePagnet=@$_POST['idMutuellePagnet'];
  $codeBeneficiaire=htmlspecialchars(trim($_POST['codeBeneficiaire']));
  $numeroRecu=htmlspecialchars(trim($_POST['numeroRecu']));
  $dateRecu=htmlspecialchars(trim($_POST['dateRecu']));

  $sql="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
  $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
  $pagnet = mysql_fetch_assoc($res) ;
  if($pagnet!=null){
      $sql0="SELECT * FROM `".$nomtableMutuelle."` where idMutuelle=".$pagnet['idMutuelle']." ";
      $res0 = mysql_query($sql0) or die ("persoonel requête 2".mysql_error());
      $mutuelle = mysql_fetch_assoc($res0) ;
      if($mutuelle!=null && ($pagnet['codeAdherant']!=null && $pagnet['codeAdherant']!=' ') && ($pagnet['adherant']!=null && $pagnet['adherant']!=' ') && ($codeBeneficiaire!='' && $numeroRecu!='' && $dateRecu!='')){
          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
          $TotalP = mysql_fetch_array($resT) ;

          $totalp=$TotalP[0];
          $apayerMutuelle= ($totalp * $pagnet['taux']) / 100;
          $apayerPagnet= $totalp - $apayerMutuelle;
          $sqlL="SELECT * FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
          $resL = mysql_query($sqlL) or die ("persoonel requête 2".mysql_error());

          /*****Debut Nombre de Panier ouvert****/
          $query = mysql_query("SELECT * FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ");
          $nbre_fois=mysql_num_rows($query);
          /*****Fin Nombre de Panier ouvert****/

          /*****Debut Difference entre Total Panier et Remise****/
          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
          $TotalT = mysql_fetch_array($resT) ;

          $difference=$TotalT[0];
          /*****Fin Difference entre Total Panier et Remise****/

          if($pagnet['verrouiller']==0){
              if($nbre_fois>0){
                  if($difference>=0){
                      mysql_query("SET AUTOCOMMIT=0;");
                      mysql_query("START TRANSACTION;");
                      $i=0;
                      $j=0;
                      while ($ligne=mysql_fetch_assoc($resL)){
                          if($ligne['classe']==0){
                              $sqlS="SELECT * FROM `".$nomtableDesignation."` WHERE idDesignation='".$ligne['idDesignation']."' ";
                              $resS=mysql_query($sqlS) or die ("select stock impossible =>".mysql_error());
                              $designation = mysql_fetch_assoc($resS) ;
                                  if(mysql_num_rows($resS)){
                                      $restant=$ligne['quantite'];
                                      $sqlD="SELECT * FROM `".$nomtableStock."` WHERE idDesignation='".$ligne['idDesignation']."' ORDER BY idStock ASC ";
                                      $resD=mysql_query($sqlD) or die ("select designation impossible =>".mysql_error());
                                      $stock0 = mysql_fetch_assoc($resD);
                                      $quantiteinitial=$stock0['quantiteStockCourant'] - $restant;
                                      if($quantiteinitial >= 0){
                                          $sqlS0="UPDATE `".$nomtableStock."` SET quantiteStockCourant='".$quantiteinitial."' WHERE idStock='".$stock0['idStock']."' ";
                                          $resS0=mysql_query($sqlS0) or die ("update stock impossible =>".mysql_error());
                                          if($resS0){
                                              $i=$i + 1;;
                                          }
                                      }
                                      else{
                                          $sqlE="SELECT * FROM `".$nomtableStock."` WHERE idDesignation='".$ligne['idDesignation']."' ORDER BY idStock ASC ";
                                          $resE=mysql_query($sqlE) or die ("select designation impossible =>".mysql_error());
                                          $k=0;
                                          $l=0;
                                          while ($stock = mysql_fetch_assoc($resE)) {
                                              if($restant>= 0){
                                                  $quantiteStockCourant = $stock['quantiteStockCourant'] - $restant;
                                                  if($quantiteStockCourant > 0){
                                                      $sqlS1="UPDATE `".$nomtableStock."` SET quantiteStockCourant='".$quantiteStockCourant."' WHERE idStock='".$stock['idStock']."' ";
                                                      $resS1=mysql_query($sqlS1) or die ("update stock impossible =>".mysql_error());
                                                      if($resS1){
                                                          $k=$k + 1;
                                                      }
                                                  }
                                                  else{
                                                      $sqlS2="UPDATE `".$nomtableStock."` SET quantiteStockCourant=0 WHERE idStock='".$stock['idStock']."' ";
                                                      $resS2=mysql_query($sqlS2) or die ("update stock impossible =>".mysql_error());
                                                      if($resS2){
                                                          $k=$k + 1;
                                                      }
                                                  }
                                                  $restant= $restant - $stock['quantiteStockCourant'] ;
                                                  $l=$l + 1;
                                              }
                                          }
                                          if($k==$l){
                                              $i=$i + 1;
                                          }
                                      }
                                  }
                          }
                          else{
                              $i=$i + 1;  
                          }
                          $j=$j + 1;
                      }
                      $sql3="UPDATE `".$nomtableMutuellePagnet."` set codeBeneficiaire='".$codeBeneficiaire."',numeroRecu='".$numeroRecu."',dateRecu='".$dateRecu."',
                      verrouiller='1',totalp=".$totalp.",apayerPagnet=".$apayerPagnet.",apayerMutuelle=".$apayerMutuelle." where idMutuellePagnet=".$idMutuellePagnet;
                      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());

                      if(($i==$j) && $res3){
                          mysql_query("COMMIT;");
                      }
                      else{
                          mysql_query("ROLLBACK;");
                          $msg_info="PROBLEME CONNECTION INTERNET .</br></br> Veuillez terminer le bon numéro ".$idMutuellePagnet.".";
                      }
                  }
                  else {
                      $msg_info="IMPOSSIBLE.</br></br> Avant de terminer le pagnet numéro ".$idMutuellePagnet.", il faut verifier la remise.";
                  }
                  
              }
              else {
                  $msg_info="IMPOSSIBLE.</br></br> Avant de terminer le pagnet numéro ".$idMutuellePagnet.", il faut au moins ajouter un produit.";
              }
          }

          if(isset($_POST['compte'])) {
              $operation='depot';
              $idCompte=$_POST['compte'];
              if ($idCompte == '2') {
                  # code...
                  $description="Bon imputation adhérant";
              } else {
                  # code...
                  $description="Encaissement imputation adhérant";
              }
              // var_dump($idCompte);
              // $description=$refTransf;
              // $newMontant=$compte['montantCompte']+$montantTransfert;

              $sql8="UPDATE `".$nomtableMutuellePagnet."`  set  idCompte=".$idCompte." where  idMutuellePagnet=".$idMutuellePagnet;
              //var_dump($sql7);
              $res8=@mysql_query($sql8) or die ("mise à jour pour activer ou pas ".mysql_error());

              $sql7="UPDATE `".$nomtableCompte."` set  montantCompte= montantCompte + ".$apayerPagnet." where  idCompte=".$idCompte;
              //var_dump($sql7);
              $res7=@mysql_query($sql7) or die ("mise à jour 2 pour activer ou pas ".mysql_error());

              $sql6="insert into `".$nomtableComptemouvement."` (montant,operation,idCompte,description,dateOperation,dateSaisie,idUser) values(".$apayerPagnet.",'".$operation."',".$idCompte.",'".$description."','".$dateHeures."','".$dateHeures."',".$_SESSION['iduser'].")";
              //var_dump($sql6);
              $res6=mysql_query($sql6) or die ("insertion Cmpte impossible =>".mysql_error() );
          }
      }
      else{
           $msg_info="IMPOSSIBLE.</br></br> Il manque des informations pour la mutuelle de sante.";
      }
  }
  else{
      $msg_info="IMPOSSIBLE.</br></br> Vous n'avez pas choisi la mutuelle de sante.";
  }

  echo $msg_info;
}
if($operation == 29){
  $msg_info='';
  
  $idMutuellePagnet=@$_POST['idMutuellePagnet'];
  $nomClient=@$_POST['nomClient'];
  // var_dump($nomClient);
  $codeBeneficiaire=htmlspecialchars(trim($_POST['codeBeneficiaire']));
  $numeroRecu=htmlspecialchars(trim($_POST['numeroRecu']));
  $dateRecu=htmlspecialchars(trim($_POST['dateRecu']));

  $sql="SELECT * FROM `".$nomtableMutuellePagnet."` where idMutuellePagnet=".$idMutuellePagnet." ";
  $res = mysql_query($sql) or die ("persoonel requête 2".mysql_error());
  $pagnet = mysql_fetch_assoc($res) ;
  if($pagnet!=null){
      $sql0="SELECT * FROM `".$nomtableMutuelle."` where idMutuelle=".$pagnet['idMutuelle']." ";
      $res0 = mysql_query($sql0) or die ("persoonel requête 2".mysql_error());
      $mutuelle = mysql_fetch_assoc($res0) ;
      if($mutuelle!=null && ($pagnet['codeAdherant']!=null && $pagnet['codeAdherant']!=' ') && ($codeBeneficiaire!='' && $numeroRecu!='' && $dateRecu!='')){
          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
          $TotalP = mysql_fetch_array($resT) ;

          $totalp=$TotalP[0];
          $apayerMutuelle= ($totalp * $pagnet['taux']) / 100;
          $apayerPagnet= $totalp - $apayerMutuelle;

          //$msg_info="<p>$totalp</p> <p>$remise</p> <p>$versement</p> <p>$apayerPagnet</p>";

          $sqlL="SELECT * FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
          $resL = mysql_query($sqlL) or die ("persoonel requête 2".mysql_error());
          //$ligne = mysql_fetch_assoc($resL) ;

          /*****Debut Nombre de Panier ouvert****/
          $query = mysql_query("SELECT * FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ");
          $nbre_fois=mysql_num_rows($query);
          /*****Fin Nombre de Panier ouvert****/

          /*****Debut Difference entre Total Panier et Remise****/
          $sqlT="SELECT SUM(prixtotal) FROM `".$nomtableLigne."` where idMutuellePagnet=".$idMutuellePagnet." ";
          $resT = mysql_query($sqlT) or die ("persoonel requête 2".mysql_error());
          $TotalT = mysql_fetch_array($resT) ;

          $difference=$TotalT[0];
          /*****Fin Difference entre Total Panier et Remise****/

          if($pagnet['verrouiller']==0){
              if($nbre_fois>0){
                  if($difference>=0){
                      mysql_query("SET AUTOCOMMIT=0;");
                      mysql_query("START TRANSACTION;");
                      $i=0;
                      $j=0;
                      while ($ligne=mysql_fetch_assoc($resL)){
                          if($ligne['classe']==0){
                              $sqlS="SELECT * FROM `".$nomtableDesignation."` WHERE idDesignation='".$ligne['idDesignation']."' ";
                              $resS=mysql_query($sqlS) or die ("select stock impossible =>".mysql_error());
                              $designation = mysql_fetch_assoc($resS) ;
                                  if(mysql_num_rows($resS)){
                                      $restant=$ligne['quantite'];
                                      $sqlD="SELECT * FROM `".$nomtableStock."` WHERE idDesignation='".$ligne['idDesignation']."' ORDER BY idStock ASC ";
                                      $resD=mysql_query($sqlD) or die ("select designation impossible =>".mysql_error());
                                      $stock0 = mysql_fetch_assoc($resD);
                                      $quantiteinitial=$stock0['quantiteStockCourant'] - $restant;
                                      if($quantiteinitial >= 0){
                                          $sqlS0="UPDATE `".$nomtableStock."` SET quantiteStockCourant='".$quantiteinitial."' WHERE idStock='".$stock0['idStock']."' ";
                                          $resS0=mysql_query($sqlS0) or die ("update stock impossible =>".mysql_error());
                                          if($resS0){
                                              $i=$i + 1;;
                                          }
                                      }
                                      else{
                                          $sqlE="SELECT * FROM `".$nomtableStock."` WHERE idDesignation='".$ligne['idDesignation']."' ORDER BY idStock ASC ";
                                          $resE=mysql_query($sqlE) or die ("select designation impossible =>".mysql_error());
                                          $k=0;
                                          $l=0;
                                          while ($stock = mysql_fetch_assoc($resE)) {
                                              if($restant>= 0){
                                                  $quantiteStockCourant = $stock['quantiteStockCourant'] - $restant;
                                                  if($quantiteStockCourant > 0){
                                                      $sqlS1="UPDATE `".$nomtableStock."` SET quantiteStockCourant='".$quantiteStockCourant."' WHERE idStock='".$stock['idStock']."' ";
                                                      $resS1=mysql_query($sqlS1) or die ("update stock impossible =>".mysql_error());
                                                      if($resS1){
                                                          $k=$k + 1;
                                                      }
                                                  }
                                                  else{
                                                      $sqlS2="UPDATE `".$nomtableStock."` SET quantiteStockCourant=0 WHERE idStock='".$stock['idStock']."' ";
                                                      $resS2=mysql_query($sqlS2) or die ("update stock impossible =>".mysql_error());
                                                      if($resS2){
                                                          $k=$k + 1;
                                                      }
                                                  }
                                                  $restant= $restant - $stock['quantiteStockCourant'] ;
                                                  $l=$l + 1;
                                              }
                                          }
                                          if($k==$l){
                                              $i=$i + 1;
                                          }
                                      }
                                  }
                          }
                          else{
                              $i=$i + 1;  
                          }
                          $j=$j + 1;
                      }
                      $sql3="UPDATE `".$nomtableMutuellePagnet."` set adherant='".$nomClient."',codeBeneficiaire='".$codeBeneficiaire."',numeroRecu='".$numeroRecu."',dateRecu='".$dateRecu."',
                      verrouiller='1',totalp=".$totalp.",apayerPagnet=".$apayerPagnet.",apayerMutuelle=".$apayerMutuelle." where idMutuellePagnet=".$idMutuellePagnet;
                      $res3=@mysql_query($sql3) or die ("mise à jour verouillage  impossible".mysql_error());
                     
                      $operation='depot';
                      $idCompte='2';
                      $description="Bon imputation adhérant";
                      // var_dump($idCompte);
                      // $description=$refTransf;
                      // $newMontant=$compte['montantCompte']+$montantTransfert;
      
                      $sql8="UPDATE `".$nomtableMutuellePagnet."`  set  idCompte=".$idCompte." where  idMutuellePagnet=".$idMutuellePagnet;
                      //var_dump($sql7);
                      $res8=@mysql_query($sql8) or die ("mise à jour pour activer ou pas ".mysql_error());
      
                      $sql7="UPDATE `".$nomtableCompte."` set  montantCompte= montantCompte + ".$apayerPagnet." where  idCompte=".$idCompte;
                      //var_dump($sql7);
                      $res7=@mysql_query($sql7) or die ("mise à jour 2 pour activer ou pas ".mysql_error());
      
                      $sql6="insert into `".$nomtableComptemouvement."` (montant,operation,idCompte,description,dateOperation,dateSaisie,idUser) values(".$apayerPagnet.",'".$operation."',".$idCompte.",'".$description."','".$dateHeures."','".$dateHeures."',".$_SESSION['iduser'].")";
                      //var_dump($sql6);
                      $res6=mysql_query($sql6) or die ("insertion Cmpte impossible =>".mysql_error());

                      if(($i==$j) && $res3){
                          mysql_query("COMMIT;");
                      }
                      else{
                          mysql_query("ROLLBACK;");
                          $msg_info="PROBLEME CONNECTION INTERNET .</br></br> Veuillez terminer le bon numéro ".$idMutuellePagnet.".";
                      }
                  }
                  else {
                      $msg_info="IMPOSSIBLE.</br></br> Avant de terminer le pagnet numéro ".$idMutuellePagnet.", il faut verifier la remise.";
                  }
                  
              }
              else {
                  $msg_info="IMPOSSIBLE.</br></br> Avant de terminer le pagnet numéro ".$idMutuellePagnet.", il faut au moins ajouter un produit.";
              }
          }

          // if(isset($_POST['compte'])) {
             
          // }
      }
      else{
           $msg_info="IMPOSSIBLE.</br></br> Il manque des informations pour la mutuelle de sante.";
      }
  }
  else{
      $msg_info="IMPOSSIBLE.</br></br> Vous n'avez pas choisi la mutuelle de sante.";
  }
  
  echo $msg_info;
}







 ?>